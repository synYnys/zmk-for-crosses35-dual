name: Draw Keymap

on:
  workflow_dispatch:
  push:
    paths:
      - "config/**.keymap"
      - "keymap_drawer.config.yaml" # 設定ファイルの変更でも動くように追加
      - ".github/workflows/draw-keymap.yml"

permissions:
  contents: write

jobs:
  draw:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Keymap Drawer
        run: pipx install keymap-drawer

      - name: Create Image Folder
        run: mkdir -p img

      - name: Generate Keymap
        run: |
          # .keymap ファイルを探す
          KEYMAP_FILE=$(find config -name "*.keymap" | head -n 1)
          
          echo "Found keymap file: $KEYMAP_FILE"
          
          if [ -z "$KEYMAP_FILE" ]; then
            echo "Error: Keymap file not found!"
            exit 1
          fi

          # 【修正点】 -c オプションで設定ファイルを強制的に指定
          echo "Generating data using config file..."
          keymap parse -c keymap_drawer.config.yaml -z "$KEYMAP_FILE" > keymap_data.yaml
          
          echo "Drawing image..."
          keymap draw -c keymap_drawer.config.yaml keymap_data.yaml > img/crosses.svg

      - name: Commit Image
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "[Draw] Update keymap diagram"
          file_pattern: "img/*.svg"
