name: Draw Keymap

on:
  workflow_dispatch:
  push:
    paths:
      - "config/**.keymap"
      - ".github/workflows/draw-keymap.yml"

permissions:
  contents: write

jobs:
  draw:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Keymap Drawer
        run: pipx install keymap-drawer

      - name: Create Image Folder
        run: mkdir -p img

      - name: Generate Keymap
        run: |
          KEYMAP_FILE=$(find config -name "*.keymap" | head -n 1)
          
          if [ -z "$KEYMAP_FILE" ]; then
            echo "Error: Keymap file not found!"
            exit 1
          fi

          echo "Parsing keymap..."
          keymap parse -z "$KEYMAP_FILE" > keymap_data.yaml
          
          echo "Applying manual layout override..."
          # 【ここが修正のキモです】
          # "crosses" という名前を、有名な "corne" に無理やり書き換えます
          # これで「知らないキーボードだ」というエラーを物理的に回避します
          sed -i 's/zmk_keyboard: crosses/zmk_keyboard: corne/g' keymap_data.yaml

          echo "Drawing image..."
          # 設定ファイルはもう使いません。書き換えたデータで描画します。
          keymap draw keymap_data.yaml > img/crosses.svg

      - name: Commit Image
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "[Draw] Update keymap diagram"
          file_pattern: "img/*.svg"
