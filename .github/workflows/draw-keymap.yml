name: Draw Keymap

on:
  workflow_dispatch:  # 手動実行ボタン
  push:               # ファイル変更時
    paths:
      - "config/**.keymap"
      - ".github/workflows/draw-keymap.yml"

permissions:
  contents: write

jobs:
  draw:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Keymap Drawer
        run: pipx install keymap-drawer

      - name: Create Image Folder
        run: mkdir -p img

      - name: Generate Keymap
        run: |
          # configフォルダの中から .keymap ファイルを強制的に探す
          KEYMAP_FILE=$(find config -name "*.keymap" | head -n 1)
          
          echo "見つかったファイル: $KEYMAP_FILE"
          
          if [ -z "$KEYMAP_FILE" ]; then
            echo "エラー: .keymap ファイルが見つかりませんでした！"
            exit 1
          fi

          # 図を生成して img/crosses.svg に保存
          keymap parse -z "$KEYMAP_FILE" > keymap_data.yaml
          keymap draw keymap_data.yaml > img/crosses.svg

      - name: Commit Image
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "[Draw] Update keymap diagram"
          file_pattern: "img/*.svg"
