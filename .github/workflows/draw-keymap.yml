name: Draw Keymap

on:
  workflow_dispatch:
  push:
    paths:
      - "config/**.keymap"
      - "keymap_drawer.config.yaml"
      - ".github/workflows/draw-keymap.yml"

permissions:
  contents: write

jobs:
  draw:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Keymap Drawer
        run: pipx install keymap-drawer

      - name: Create Image Folder
        run: mkdir -p img

      - name: Generate Keymap
        run: |
          KEYMAP_FILE=$(find config -name "*.keymap" | head -n 1)
          
          if [ -z "$KEYMAP_FILE" ]; then
            echo "Error: Keymap file not found!"
            exit 1
          fi

          echo "Parsing keymap..."
          keymap parse -z "$KEYMAP_FILE" > keymap_data.yaml
          
          echo "Drawing image..."
          # 【修正箇所】 -c オプションを draw の前に移動しました
          keymap -c keymap_drawer.config.yaml draw keymap_data.yaml > img/crosses.svg

      - name: Commit Image
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "[Draw] Update keymap diagram"
          file_pattern: "img/*.svg"
